# عیب‌یابی عمومی

این بخش شامل راهنمای عیب‌یابی مشکلات رایج در QUIC VPN، نحوه تفسیر لاگ‌ها، ابزارهای تشخیصی و پاسخ به سوالات متداول است.

## مشکلات رایج

### مشکلات نصب و راه‌اندازی

#### مشکل: نصب ناموفق کلاینت

**علائم**:
- برنامه نصب با خطا متوقف می‌شود
- پیام خطا مبنی بر نصب ناموفق درایور TUN
- خطای "Access Denied" در طول نصب

**راه حل‌ها**:
1. اطمینان از اجرای نصب‌کننده با دسترسی Administrator:
   - راست کلیک روی فایل نصب و انتخاب "Run as administrator"

2. غیرفعال کردن موقت آنتی‌ویروس یا فایروال:
   - برخی برنامه‌های امنیتی ممکن است با نصب درایور TUN تداخل داشته باشند

3. بررسی سازگاری سیستم عامل:
   - اطمینان از استفاده از ویندوز 10 (نسخه 1903 یا بالاتر) یا ویندوز 11

4. نصب در حالت Safe Mode:
   - راه‌اندازی ویندوز در حالت Safe Mode با شبکه
   - اجرای مجدد نصب‌کننده

#### مشکل: نصب ناموفق سرور

**علائم**:
- خطا در اجرای اسکریپت نصب سرور
- خطای "Failed to create TUN device"
- خطای مربوط به دسترسی‌های فایل

**راه حل‌ها**:
1. بررسی دسترسی‌ها:
   ```bash
   # اطمینان از اجرای نصب با دسترسی root
   sudo ./install.sh
   ```

2. بررسی سازگاری سیستم عامل:
   ```bash
   # بررسی نسخه کرنل لینوکس
   uname -r
   # باید حداقل 3.17 باشد
   ```

3. نصب کتابخانه‌های مورد نیاز:
   ```bash
   # برای توزیع‌های مبتنی بر Debian
   sudo apt update
   sudo apt install build-essential pkg-config libssl-dev
   ```

### مشکلات اتصال

#### مشکل: عدم برقراری اتصال بین کلاینت و سرور

**علائم**:
- پیام خطای "Connection failed" در کلاینت
- پیام "Handshake timeout" در لاگ سرور
- ناتوانی در برقراری اتصال پس از تلاش‌های متعدد

**راه حل‌ها**:
1. بررسی تنظیمات فایروال:
   - در سرور:
     ```bash
     # اطمینان از باز بودن پورت UDP
     sudo iptables -L -n | grep 4433
     ```
   - در کلاینت:
     ```powershell
     # اطمینان از دسترسی کلاینت به شبکه
     New-NetFirewallRule -DisplayName "QUIC VPN Client" -Direction Outbound -Program "C:\Program Files\QUIC VPN\client.exe" -Action Allow
     ```

2. بررسی دسترسی به سرور:
   ```bash
   # در سیستم کلاینت
   ping server_ip
   nc -zv server_ip 4433 -u
   ```

3. بررسی صحت اطلاعات اتصال:
   - اطمینان از صحت آدرس سرور، پورت، نام کاربری و رمز عبور
   - امتحان استفاده از آدرس IP به جای نام دامنه

4. بررسی محدودیت‌های ISP:
   - برخی ISPها ممکن است پروتکل QUIC را محدود کرده باشند
   - امتحان استفاده از پورت متفاوت در تنظیمات سرور

5. بررسی گواهینامه TLS:
   - اطمینان از معتبر بودن گواهینامه TLS سرور
   - در صورت استفاده از گواهینامه خودامضا، فعال کردن گزینه "allow_insecure" در کلاینت

#### مشکل: قطع مکرر اتصال

**علائم**:
- قطع و وصل شدن مکرر اتصال VPN
- پیام‌های خطای "Lost connection to server" در لاگ کلاینت
- لاگ‌های "Client timeout" در سرور

**راه حل‌ها**:
1. افزایش زمان keepalive:
   - در کلاینت:
     ```powershell
     .\client.exe config set keep_alive 5
     ```
   - در سرور:
     ```bash
     # ویرایش فایل config.json
     # "keep_alive": 5
     ```

2. افزایش زمان timeout:
   - در کلاینت:
     ```powershell
     .\client.exe config set connection_timeout 60
     ```
   - در سرور:
     ```bash
     # ویرایش فایل config.json
     # "idle_timeout": 120
     ```

3. بررسی پایداری اتصال اینترنت:
   - اجرای ping طولانی مدت برای بررسی پایداری
     ```bash
     ping -t 8.8.8.8  # در ویندوز
     ping -c 100 8.8.8.8  # در لینوکس
     ```

4. کاهش حجم انتقال داده:
   - کاهش MTU:
     ```powershell
     .\client.exe config set mtu 1300
     ```

### مشکلات عملکرد

#### مشکل: سرعت پایین یا تأخیر بالا

**علائم**:
- سرعت دانلود/آپلود پایین‌تر از حد انتظار
- تأخیر بالا در بازی‌ها و برنامه‌های حساس به تأخیر
- بافرینگ در هنگام استریم ویدیو

**راه حل‌ها**:
1. انتخاب سرور نزدیک‌تر:
   - اتصال به سروری که از نظر جغرافیایی نزدیک‌تر است
   - بررسی ping به سرور قبل از اتصال

2. بهینه‌سازی MTU:
   - یافتن MTU بهینه:
     ```powershell
     # در ویندوز
     ping server_ip -f -l 1500
     # کاهش عدد تا زمانی که پیام "Packet needs to be fragmented but DF set" دریافت نشود
     ```
   - تنظیم MTU جدید:
     ```powershell
     .\client.exe config set mtu [مقدار_بهینه]
     ```

3. فعال کردن بهینه‌سازی‌های گیمینگ:
   - در کلاینت:
     ```powershell
     .\client.exe config set gaming_optimization true
     .\client.exe config set game_type FPS  # برای بازی‌های تیراندازی
     ```

4. بررسی تنظیمات تشخیص ازدحام:
   - در سرور (برای مدیران):
     ```bash
     # ویرایش فایل پیکربندی برای تنظیم الگوریتم تشخیص ازدحام
     # "congestion_algorithm": "bbr"
     ```

5. استفاده از Split Tunneling:
   - تنظیم کلاینت برای عبور فقط ترافیک ضروری از VPN

#### مشکل: مصرف بالای منابع سیستم

**علائم**:
- استفاده بالای CPU توسط فرآیند VPN
- استفاده بالای حافظه
- کاهش کارایی کلی سیستم

**راه حل‌ها**:
1. کاهش سطح لاگ:
   ```powershell
   .\client.exe config set log_level warn
   ```

2. بررسی مشکلات استریم:
   - ممکن است تعداد زیادی استریم باز شده باشد
   - برای توسعه‌دهندگان: بررسی کد مربوط به مدیریت استریم‌ها

3. محدود کردن تعداد اتصال‌های همزمان:
   - در سرور:
     ```bash
     # ویرایش فایل config.json
     # "max_connections_per_client": 5
     ```

4. بروزرسانی به آخرین نسخه:
   - نسخه‌های جدیدتر معمولاً بهینه‌سازی‌های عملکرد دارند

### مشکلات مسیریابی و DNS

#### مشکل: مشکلات DNS

**علائم**:
- ناتوانی در رزولو کردن نام دامنه‌ها
- دسترسی به سایت‌ها با آدرس IP اما نه با نام دامنه
- خطای "DNS resolution failed"

**راه حل‌ها**:
1. تغییر سرورهای DNS:
   ```powershell
   .\client.exe config set dns_servers ["8.8.8.8","1.1.1.1"]
   ```

2. بررسی نشت DNS:
   - استفاده از وب‌سایت‌های تست نشت DNS
   - فعال کردن DNS over QUIC اگر پشتیبانی می‌شود

3. پاک کردن کش DNS:
   ```powershell
   ipconfig /flushdns
   ```

4. استفاده از DNS سرور:
   ```powershell
   .\client.exe config set use_server_dns true
   ```

#### مشکل: مشکلات مسیریابی

**علائم**:
- دسترسی به برخی سایت‌ها اما نه همه
- عدم دسترسی به برخی شبکه‌های محلی
- مشکلات دوگانگی مسیر

**راه حل‌ها**:
1. بررسی جدول مسیریابی:
   ```powershell
   # در ویندوز
   route print
   # در لینوکس
   ip route
   ```

2. تنظیم Split Tunneling:
   ```powershell
   # برای دسترسی به شبکه محلی بدون استفاده از VPN
   .\client.exe tunnel exclude 192.168.0.0/16
   ```

3. اصلاح مسیرهای ثابت:
   ```powershell
   # افزودن مسیر برای شبکه محلی
   route add 192.168.1.0 mask 255.255.255.0 192.168.1.1
   ```

4. بررسی تداخل با سایر VPNها:
   - اطمینان از غیرفعال بودن سایر سرویس‌های VPN

## تفسیر لاگ‌ها

### محل لاگ‌ها

- **کلاینت ویندوز**:
  - `C:\ProgramData\QUIC VPN\logs\`
  - `%APPDATA%\QUIC VPN\logs\`

- **سرور لینوکس**:
  - `/var/log/quicvpn.log`
  - `/var/log/syslog` (لاگ‌های systemd)

### الگوهای خطای رایج

#### الگوی خطای "Handshake failed"

```
[ERROR] 2023-09-15 12:34:56 - TLS handshake failed: error:1000007d:SSL routines:OPENSSL_internal:CERTIFICATE_VERIFY_FAILED
```

**تفسیر**: خطا در تأیید گواهینامه TLS. ممکن است گواهینامه منقضی شده، خودامضا باشد، یا کلاینت به آن اعتماد نکند.

**راه حل**:
- بررسی تاریخ انقضای گواهینامه
- در صورت استفاده از گواهینامه خودامضا، تنظیم کلاینت برای قبول آن
- تجدید گواهینامه در صورت نیاز

#### الگوی خطای "Connection reset"

```
[ERROR] 2023-09-15 12:34:56 - Connection reset by peer
```

**تفسیر**: ارتباط توسط طرف مقابل قطع شده است. می‌تواند به دلیل مشکلات شبکه، قطع ناگهانی سرور، یا تایم‌اوت باشد.

**راه حل**:
- بررسی اتصال اینترنت
- بررسی وضعیت سرور
- افزایش زمان keepalive و timeout

#### الگوی خطای "Unable to allocate IP"

```
[ERROR] 2023-09-15 12:34:56 - Failed to allocate IP address: no available addresses in pool
```

**تفسیر**: سرور نمی‌تواند آدرس IP به کلاینت جدید اختصاص دهد، زیرا تمام آدرس‌های موجود در استخر آدرس‌ها استفاده شده‌اند.

**راه حل**:
- افزایش محدوده IP در تنظیمات سرور
- آزادسازی اتصال‌های غیرفعال
- بررسی نشت آدرس IP

#### الگوی خطای "Authentication failed"

```
[ERROR] 2023-09-15 12:34:56 - Authentication failed for user: username
```

**تفسیر**: احراز هویت کاربر ناموفق بوده است. نام کاربری یا رمز عبور اشتباه است، یا حساب کاربری غیرفعال شده است.

**راه حل**:
- بررسی صحت نام کاربری و رمز عبور
- بررسی وضعیت حساب کاربری در سرور
- تنظیم مجدد رمز عبور در صورت نیاز

### تحلیل عملکرد از طریق لاگ‌ها

#### بررسی زمان اتصال

```
[INFO] 2023-09-15 12:34:56 - Connection attempt started
[INFO] 2023-09-15 12:34:57 - TLS handshake completed
[INFO] 2023-09-15 12:34:57 - Authentication successful
[INFO] 2023-09-15 12:34:58 - Connection established
```

**تفسیر**: اتصال در حدود 2 ثانیه برقرار شده است. زمان عادی برای اتصال بین 1 تا 3 ثانیه است.

#### بررسی سرعت انتقال داده

```
[DEBUG] 2023-09-15 12:35:00 - Data transfer stats: 1.2 MB/s download, 0.5 MB/s upload, RTT 45ms
```

**تفسیر**: سرعت دانلود 1.2 مگابایت بر ثانیه، سرعت آپلود 0.5 مگابایت بر ثانیه و زمان رفت و برگشت 45 میلی‌ثانیه است.

## ابزارهای تشخیصی

### ابزارهای داخلی QUIC VPN

#### ابزار تشخیصی کلاینت

کلاینت QUIC VPN دارای ابزارهای تشخیصی داخلی است:

```powershell
# تست اتصال به سرور
.\client.exe diagnose connection --server example.com:4433

# تست سرعت VPN
.\client.exe diagnose speed

# بررسی نشت DNS
.\client.exe diagnose dns-leak

# گزارش کامل تشخیصی
.\client.exe diagnose full-report
```

#### ابزار تشخیصی سرور

سرور QUIC VPN نیز دارای ابزارهای تشخیصی است:

```bash
# بررسی وضعیت سرور
quicvpn-server --status

# تست پیکربندی
quicvpn-server --test-config

# بررسی اتصالات فعال
quicvpn-server --list-connections

# آمار ترافیک
quicvpn-server --traffic-stats
```

### ابزارهای خارجی برای عیب‌یابی

#### ابزارهای شبکه

برای عیب‌یابی مشکلات شبکه، می‌توان از ابزارهای زیر استفاده کرد:

1. **Wireshark**: برای تحلیل عمیق ترافیک شبکه
   - تنظیم فیلتر `udp.port == 4433` برای مشاهده ترافیک QUIC

2. **tcpdump**: در لینوکس برای ضبط ترافیک شبکه
   ```bash
   sudo tcpdump -i eth0 udp port 4433 -w quicvpn.pcap
   ```

3. **iperf3**: برای تست سرعت و پهنای باند
   ```bash
   # در سرور
   iperf3 -s

   # در کلاینت (پس از اتصال به VPN)
   iperf3 -c server_ip
   ```

4. **mtr** / **WinMTR**: برای بررسی مسیر شبکه و تشخیص گلوگاه‌ها
   ```bash
   mtr server_ip
   ```

5. **nslookup** / **dig**: برای عیب‌یابی مشکلات DNS
   ```bash
   nslookup example.com 8.8.8.8
   ```

#### ابزارهای نظارت بر سیستم

برای بررسی تأثیر QUIC VPN بر منابع سیستم:

1. **Task Manager** در ویندوز / **top** یا **htop** در لینوکس:
   - نظارت بر مصرف CPU و حافظه

2. **Resource Monitor** در ویندوز:
   - بررسی دقیق‌تر فعالیت شبکه و I/O دیسک

3. **Performance Monitor** در ویندوز:
   - ثبت و تحلیل عملکرد سیستم در طول زمان

4. **netstat** / **ss**: برای بررسی اتصالات فعال
   ```bash
   netstat -tunap | grep quicvpn
   ```

## سوالات متداول

### سوالات عمومی

#### آیا QUIC VPN با سایر VPNها سازگار است؟

**پاسخ**: توصیه می‌شود فقط از یک سرویس VPN در یک زمان استفاده کنید. استفاده همزمان از چند VPN می‌تواند منجر به مشکلات مسیریابی و عملکرد شود. قبل از اتصال به QUIC VPN، سایر سرویس‌های VPN را قطع کنید.

#### چگونه می‌توانم بفهمم VPN به درستی کار می‌کند؟

**پاسخ**: پس از اتصال، می‌توانید با مراجعه به وب‌سایت‌هایی مانند whatismyip.com آدرس IP خود را بررسی کنید. همچنین، می‌توانید از ابزار داخلی تشخیصی استفاده کنید:
```powershell
.\client.exe diagnose connection
```

#### آیا باید لاگ‌ها را دوره‌ای پاک کنم؟

**پاسخ**: بله، پاک کردن دوره‌ای لاگ‌ها توصیه می‌شود، به خصوص در سرور. لاگ‌های قدیمی می‌توانند حجم زیادی از فضای دیسک را اشغال کنند. می‌توانید یک cron job در سرور تنظیم کنید:
```bash
0 0 * * 0 find /var/log/quicvpn -type f -name "*.log.*" -mtime +30 -exec rm {} \;
```

### سوالات امنیتی

#### آیا ترافیک من با QUIC VPN رمزنگاری می‌شود؟

**پاسخ**: بله، تمام ترافیک بین کلاینت و سرور QUIC VPN با استفاده از TLS 1.3 رمزنگاری می‌شود. این یکی از مزایای اصلی پروتکل QUIC است که امنیت بالایی را فراهم می‌کند.

#### آیا QUIC VPN از نشت DNS جلوگیری می‌کند؟

**پاسخ**: بله، QUIC VPN به صورت پیش‌فرض از نشت DNS جلوگیری می‌کند، زیرا تمام درخواست‌های DNS را از طریق تونل VPN هدایت می‌کند. برای اطمینان بیشتر، می‌توانید از ابزار تشخیصی نشت DNS استفاده کنید:
```powershell
.\client.exe diagnose dns-leak
```

#### آیا QUIC VPN لاگ‌های فعالیت کاربران را نگهداری می‌کند؟

**پاسخ**: پیکربندی پیش‌فرض QUIC VPN شامل لاگ‌های حداقلی برای مقاصد عیب‌یابی است، اما اطلاعات محتوای ترافیک را ثبت نمی‌کند. مدیران سرور می‌توانند سطح لاگ را تغییر دهند و سیاست نگهداری لاگ را تنظیم کنند.

### سوالات عملکرد

#### چرا سرعت VPN من از اتصال عادی اینترنت کندتر است؟

**پاسخ**: کاهش سرعت تا حدی طبیعی است، زیرا ترافیک از مسیر بیشتری عبور می‌کند و رمزنگاری می‌شود. برای بهبود سرعت:
1. اتصال به نزدیک‌ترین سرور
2. استفاده از بهینه‌سازی‌های عملکرد
3. تنظیم MTU بهینه
4. استفاده از Split Tunneling برای ترافیک غیرضروری

#### چه عواملی بر تأخیر (latency) تأثیر می‌گذارند؟

**پاسخ**: عوامل اصلی مؤثر بر تأخیر عبارتند از:
1. فاصله فیزیکی بین شما و سرور VPN
2. کیفیت اتصال اینترنت و ISP شما
3. ازدحام شبکه در ساعات شلوغ
4. تنظیمات VPN (keepalive، MTU، الگوریتم‌های کنترل ازدحام)
5. عملکرد سخت‌افزار سرور و کلاینت

### سوالات توسعه و پیکربندی

#### چگونه می‌توانم به کد منبع QUIC VPN مشارکت کنم؟

**پاسخ**: QUIC VPN یک پروژه متن‌باز است و مشارکت‌ها استقبال می‌شود. برای مشارکت:
1. مخزن GitHub را fork کنید
2. تغییرات خود را در یک شاخه جدید ایجاد کنید
3. تست‌ها را اجرا کنید تا از درستی تغییرات اطمینان حاصل کنید
4. یک pull request ایجاد کنید
لطفاً به [راهنمای مشارکت‌کنندگان](10-development.md) برای جزئیات بیشتر مراجعه کنید.

#### آیا می‌توانم چندین اتصال همزمان به یک سرور داشته باشم؟

**پاسخ**: بله، QUIC VPN اجازه چندین اتصال همزمان از یک حساب کاربری را می‌دهد. مدیر سرور می‌تواند حداکثر تعداد اتصال‌های همزمان برای هر کاربر را تنظیم کند:
```json
{
    "username": "user1",
    "max_connections": 3
}
```

## منابع اضافی

- [مستندات رسمی پروتکل QUIC](https://quicwg.org/)
- [راهنمای جامع مسیریابی در ویندوز](https://docs.microsoft.com/en-us/windows-server/networking/technologies/network-subsystem/net-sub-interface-metric)
- [راهنمای عیب‌یابی Wireshark برای QUIC](https://wiki.wireshark.org/QUIC)
- [انجمن کاربران QUIC VPN](https://forum.example.com/quicvpn) - برای پرسش و پاسخ و به اشتراک‌گذاری تجربیات

---

**نکته**: اگر با مشکلی مواجه شدید که در این مستندات به آن پرداخته نشده است، می‌توانید به [انجمن پشتیبانی](https://support.example.com) مراجعه کنید یا از طریق [ایمیل پشتیبانی](mailto:support@example.com) با ما تماس بگیرید. 