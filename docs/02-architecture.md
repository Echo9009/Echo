# معماری سیستم

## نمای کلی معماری

QUIC VPN دارای معماری کلاینت-سرور است که از پروتکل QUIC برای برقراری ارتباط بین اجزای سیستم استفاده می‌کند. این معماری از سه بخش اصلی تشکیل شده است:

1. **کتابخانه مشترک (common)**: کدهای مشترک بین کلاینت و سرور
2. **سرور (server)**: اجرا شده روی لینوکس
3. **کلاینت (client)**: اجرا شده روی ویندوز

### دیاگرام کلی معماری

```
┌──────────────────┐      QUIC      ┌──────────────────┐
│  کلاینت ویندوز   │◄──────────────►│   سرور لینوکس   │
└────────┬─────────┘                └────────┬─────────┘
         │                                   │
         ▼                                   ▼
┌──────────────────┐                ┌──────────────────┐
│    TUN Device    │                │    TUN Device    │
└────────┬─────────┘                └────────┬─────────┘
         │                                   │
         ▼                                   ▼
┌──────────────────┐                ┌──────────────────┐
│   ترافیک کاربر   │                │   شبکه اینترنت   │
└──────────────────┘                └──────────────────┘
```

## ساختار ماژولار

پروژه QUIC VPN به صورت ماژولار طراحی شده است تا قابلیت توسعه و نگهداری آسان‌تری داشته باشد. ساختار ماژول‌های اصلی به شرح زیر است:

### 1. کتابخانه مشترک (common)

کتابخانه common شامل کدهای مشترک بین کلاینت و سرور است که باعث جلوگیری از تکرار کد و اطمینان از سازگاری بین اجزا می‌شود.

- **protocol.rs**: تعریف پروتکل ارتباطی بین کلاینت و سرور
- **crypto.rs**: توابع رمزنگاری و مدیریت گواهینامه‌ها
- **tun_device.rs**: رابط برای مدیریت TUN device
- **config.rs**: مدیریت پیکربندی سیستم
- **error.rs**: انواع خطاها و مدیریت آن‌ها

### 2. سرور (server)

ماژول سرور مسئول پذیرش اتصال‌های کلاینت، احراز هویت، و مدیریت ترافیک شبکه است.

- **main.rs**: نقطه ورود برنامه سرور
- **client_manager.rs**: مدیریت اتصال‌های کلاینت
- **ip_allocator.rs**: تخصیص IP به کلاینت‌ها
- **user_db.rs**: مدیریت کاربران و احراز هویت

### 3. کلاینت (client)

ماژول کلاینت مسئول برقراری اتصال با سرور و هدایت ترافیک کاربر است.

- **main.rs**: نقطه ورود برنامه کلاینت
- **vpn_client.rs**: پیاده‌سازی منطق اصلی کلاینت
- **windows_service.rs**: مدیریت سرویس ویندوز (در پلتفرم ویندوز)

## جریان داده و پروتکل‌ها

### پروتکل ارتباطی

ارتباط بین کلاینت و سرور از طریق پروتکل QUIC با استفاده از پیام‌های تعریف شده در `protocol.rs` انجام می‌شود. این پیام‌ها شامل:

1. **ClientHello**: ارسال شده توسط کلاینت برای برقراری اتصال اولیه
2. **ServerHello**: پاسخ سرور به درخواست کلاینت
3. **PacketData**: انتقال داده‌های شبکه
4. **KeepAlive**: حفظ اتصال فعال
5. **Disconnect**: اعلام قطع اتصال
6. **GameOptimizationInfo**: تنظیمات بهینه‌سازی گیمینگ
7. **RouteUpdate**: بروزرسانی مسیرهای شبکه
8. **Stats**: آمار و اطلاعات عملکرد

### جریان داده

1. **شروع اتصال**:
   - کلاینت یک پیام `ClientHello` به سرور می‌فرستد
   - سرور هویت کلاینت را تأیید می‌کند
   - سرور یک آدرس IP به کلاینت اختصاص می‌دهد
   - سرور یک پیام `ServerHello` به کلاینت می‌فرستد

2. **انتقال داده**:
   - بسته‌های IP از interface محلی توسط TUN device کلاینت خوانده می‌شوند
   - بسته‌ها توسط پیام‌های `PacketData` به سرور ارسال می‌شوند
   - سرور بسته‌ها را به شبکه مقصد هدایت می‌کند
   - پاسخ‌ها از شبکه مقصد توسط سرور دریافت و به کلاینت ارسال می‌شوند

3. **پایان اتصال**:
   - کلاینت یا سرور یک پیام `Disconnect` ارسال می‌کند
   - منابع آزاد می‌شوند (آدرس IP، استریم‌ها و غیره)

### نحوه استفاده از QUIC Streams

QUIC VPN از قابلیت multiplexed streams پروتکل QUIC به شکل زیر استفاده می‌کند:

1. **استریم کنترلی**: یک استریم دوطرفه برای تبادل پیام‌های کنترلی مانند `ClientHello`، `ServerHello`، و `Disconnect`
2. **استریم‌های داده**: برای انتقال داده‌های کاربر با استفاده از پیام‌های `PacketData`
3. **استریم‌های مدیریتی**: برای ارسال آمار، اطلاعات بهینه‌سازی و پیام‌های `KeepAlive`

## معماری امنیتی

امنیت در QUIC VPN از چند لایه تشکیل شده است:

1. **QUIC + TLS 1.3**: رمزنگاری در لایه انتقال با استفاده از پروتکل‌های استاندارد
2. **احراز هویت کاربر**: نام کاربری و رمز عبور
3. **مدیریت گواهینامه**: گواهینامه‌های سرور برای اعتبارسنجی هویت سرور
4. **ایزوله‌سازی شبکه**: جداسازی ترافیک کاربران مختلف

## عیب‌یابی معماری

### مشکل: درک نادرست مسیر جریان داده

**علائم**:
- ناتوانی در برقراری اتصال
- عدم انتقال داده بین کلاینت و سرور

**راه حل**:
- بررسی لاگ‌های سیستم برای مشاهده جریان پیام‌ها
- اطمینان از اجرای صحیح مراحل احراز هویت و برقراری اتصال
- بررسی تنظیمات TUN device در هر دو سمت

### مشکل: تداخل با دیگر سرویس‌های VPN

**علائم**:
- خطا در ایجاد TUN device
- مشکلات مسیریابی شبکه

**راه حل**:
- اطمینان از غیرفعال بودن دیگر سرویس‌های VPN
- بررسی جدول مسیریابی قبل و بعد از اتصال
- استفاده از ابزارهای تشخیصی شبکه مانند `wireshark` یا `tcpdump`

### مشکل: مشکلات مرتبط با استریم‌های QUIC

**علائم**:
- انتقال ناقص داده‌ها
- کندی یا توقف ناگهانی انتقال داده

**راه حل**:
- بررسی نحوه مدیریت استریم‌ها در کد (به بخش مدیریت استریم‌ها مراجعه کنید)
- بازنگری منطق باز کردن و بستن استریم‌ها
- بررسی تنظیمات flow control در پروتکل QUIC

### مشکل: مشکلات مرتبط با مقیاس‌پذیری سرور

**علائم**:
- کاهش کارایی با افزایش تعداد کاربران
- استفاده بالا از منابع سیستم

**راه حل**:
- بهینه‌سازی مدیریت منابع در سرور
- استفاده از مکانیزم‌های کش و کاهش پردازش‌های تکراری
- بررسی الگوریتم‌های مدیریت کانکشن‌ها و استریم‌ها در سرور 